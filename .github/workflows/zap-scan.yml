name: OWASP ZAP Security Scan

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      target_url:
        description: 'Target URL to scan'
        required: false
        default: 'https://azure-dev.pomerleau.ca/Tableau_SST_Dev/'

env:
  DEFAULT_TARGET: 'https://azure-dev.pomerleau.ca/Tableau_SST_Dev/'

jobs:
  zap-scan:
    name: ZAP Baseline Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set target URL
        id: set-target
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ github.event.inputs.target_url }}" ]; then
            echo "TARGET=${{ github.event.inputs.target_url }}" >> $GITHUB_ENV
          else
            echo "TARGET=${{ env.DEFAULT_TARGET }}" >> $GITHUB_ENV
          fi

      - name: Create reports directory
        run: mkdir -p "$GITHUB_WORKSPACE/zap-reports"

      - name: Run ZAP Baseline (official action)
        id: run-zap-action
        uses: zaproxy/action-baseline@v0.14.0
        with:
          target: ${{ env.TARGET }}
          # avoid creating GitHub issues from this integration (runner token may lack permissions)
          allow_issue_writing: false
          # do not fail the job automatically; we'll surface results via artifacts
          fail_action: false

      - name: List generated reports
        run: |
          echo "Workspace files:"
          ls -la "$GITHUB_WORKSPACE" || true
          echo "Top-level report files:"
          find "$GITHUB_WORKSPACE" -maxdepth 3 -type f \( -iname '*report*.html' -o -iname '*report*.json' -o -iname '*report*.md' -o -iname 'zap.yaml' \) -print || true

      - name: Upload HTML reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-html-reports
          path: '**/report*.html'
          retention-days: 30

      - name: Upload JSON reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-json-reports
          path: '**/report*.json'
          retention-days: 30

      - name: Upload Markdown reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-md-reports
          path: '**/report*.md'
          retention-days: 30

      - name: Upload any ZAP yaml files
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-yaml-files
          path: '**/*zap*.yaml'
          retention-days: 30

      - name: Add scan summary to workflow run
        if: always()
        run: |
          echo "## ZAP Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Target:** $TARGET" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Artifacts (download from the run): https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Files produced in workspace (top matches)" >> $GITHUB_STEP_SUMMARY
          find "$GITHUB_WORKSPACE" -maxdepth 3 -type f \( -iname '*report*.html' -o -iname '*report*.json' -o -iname '*report*.md' -o -iname '*zap*.yaml' \) -print | sed -n '1,50p' >> $GITHUB_STEP_SUMMARY || true
          echo "" >> $GITHUB_STEP_SUMMARY
          # If a JSON report exists anywhere, show a detailed markdown summary (counts + top alerts)
          REPJSON=$(find "$GITHUB_WORKSPACE" -type f \( -iname 'report*.json' -o -iname 'report_*.json' -o -iname '*report*.json' -o -iname '*zap*.json' \) -print -quit)
          if [ -n "$REPJSON" ]; then
            echo "### Findings (generated from $REPJSON)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Alert counts by risk**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            # Produce counts grouped by risk (High/Medium/Low/Informational)
            jq -r '
              [ ( ( .site // .sites // [] )
                  | ( if type=="array" then .[] else . end )
                  | ( .alerts? // [] )
                  | .[]? | (.risk // "Informational") ) ]
              | group_by(.) | map({risk: .[0], count: length}) | sort_by(-.count)[] | "- \(.risk): \(.count)"
            ' "$REPJSON" 2>/dev/null >> $GITHUB_STEP_SUMMARY || true
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Top alerts (by occurrence)**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            # Table header
            echo "| Risk | Count | Alert | Example URL |" >> $GITHUB_STEP_SUMMARY
            echo "|---|---:|---|---|" >> $GITHUB_STEP_SUMMARY
            # Emit up to 20 alerts, sorted by occurrences
            jq -r '
              [ ( ( .site // .sites // [] )
                  | ( if type=="array" then .[] else . end )
                  | ( .alerts? // [] )
                  | .[]? | {name: .name, risk: (.risk // "Informational"), instances: (.instances // []) } ) ]
              | group_by(.name)
              | map({ name: .[0].name, risk: .[0].risk, count: (map(.instances|length) | add), url: (.[0].instances[0].uri // .[0].instances[0].url // "") })
              | sort_by(-.count) | .[] | [ .risk, (.count|tostring), .name, .url ] | @tsv
            ' "$REPJSON" 2>/dev/null |
              sort -t$'\t' -k2,2nr |
              head -n 20 |
              while IFS=$'\t' read -r risk cnt name url; do
                # escape pipe characters in name and url
                safe_name=$(echo "$name" | sed 's/|/\\|/g' | sed 's/\n/ /g')
                safe_url=$(echo "$url" | sed 's/|/\\|/g' | sed 's/\n/ /g')
                echo "| $risk | $cnt | $safe_name | $safe_url |" >> $GITHUB_STEP_SUMMARY
              done
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Full HTML/JSON/MD reports are attached as artifacts â€” download from the run to view the complete report." >> $GITHUB_STEP_SUMMARY
          else
            echo "No JSON report found in workspace; download the artifacts to view the full report." >> $GITHUB_STEP_SUMMARY
          fi
