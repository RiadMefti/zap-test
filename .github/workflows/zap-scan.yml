name: OWASP ZAP Security Scan

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      target_url:
        description: 'Target URL to scan'
        required: false
        default: 'https://azure-dev.pomerleau.ca/Tableau_SST_Dev/'

env:
  DEFAULT_TARGET: 'https://azure-dev.pomerleau.ca/Tableau_SST_Dev/'

jobs:
  zap-scan:
    name: ZAP Baseline Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set target URL
        id: set-target
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ github.event.inputs.target_url }}" ]; then
            echo "TARGET=${{ github.event.inputs.target_url }}" >> $GITHUB_ENV
          else
            echo "TARGET=${{ env.DEFAULT_TARGET }}" >> $GITHUB_ENV
          fi

      - name: Create reports directory
        run: mkdir -p "$GITHUB_WORKSPACE/zap-reports"

      - name: Run ZAP Baseline (official action)
        id: run-zap-action
        uses: zaproxy/action-baseline@v0.14.0
        with:
          target: ${{ env.TARGET }}
          # avoid creating GitHub issues from this integration (runner token may lack permissions)
          allow_issue_writing: false
          # do not fail the job automatically; we'll surface results via artifacts
          fail_action: false

      - name: List generated reports
        run: |
          echo "Workspace files:"
          ls -la "$GITHUB_WORKSPACE" || true
          echo "Top-level report files:"
          find "$GITHUB_WORKSPACE" -maxdepth 3 -type f \( -iname '*report*.html' -o -iname '*report*.json' -o -iname '*report*.md' -o -iname 'zap.yaml' \) -print || true

      - name: Upload HTML reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-html-reports
          path: '**/report*.html'
          retention-days: 30

      - name: Upload JSON reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-json-reports
          path: '**/report*.json'
          retention-days: 30

      - name: Upload Markdown reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-md-reports
          path: '**/report*.md'
          retention-days: 30

      - name: Upload any ZAP yaml files
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-yaml-files
          path: '**/*zap*.yaml'
          retention-days: 30

      - name: Add scan summary to workflow run
        if: always()
        run: |
          echo "## ZAP Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Target:** $TARGET" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Artifacts (download from the run): https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Files produced in workspace (top matches)" >> $GITHUB_STEP_SUMMARY
          find "$GITHUB_WORKSPACE" -maxdepth 3 -type f \( -iname '*report*.html' -o -iname '*report*.json' -o -iname '*report*.md' -o -iname '*zap*.yaml' \) -print | sed -n '1,50p' >> $GITHUB_STEP_SUMMARY || true
          echo "" >> $GITHUB_STEP_SUMMARY
          # If a JSON report exists anywhere, show a quick count of alerts
          REPJSON=$(find "$GITHUB_WORKSPACE" -type f -iname 'report*.json' -print -quit)
          if [ -n "$REPJSON" ]; then
            echo "### Quick findings from first JSON report: $REPJSON" >> $GITHUB_STEP_SUMMARY
            jq '.site[]?.alerts | length as $n | {alerts_count: $n}' "$REPJSON" 2>/dev/null | sed -n '1,40p' >> $GITHUB_STEP_SUMMARY || true
          fi
