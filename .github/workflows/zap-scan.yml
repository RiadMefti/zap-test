name: OWASP ZAP Security Scan

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      target_url:
        description: 'Target URL to scan'
        required: false
        default: 'https://azure-dev.pomerleau.ca/Tableau_SST_Dev/'

env:
  DEFAULT_TARGET: 'https://azure-dev.pomerleau.ca/Tableau_SST_Dev/'

jobs:
  zap-scan:
    name: ZAP Baseline Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set target URL
        id: set-target
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ github.event.inputs.target_url }}" ]; then
            echo "TARGET=${{ github.event.inputs.target_url }}" >> $GITHUB_ENV
          else
            echo "TARGET=${{ env.DEFAULT_TARGET }}" >> $GITHUB_ENV
          fi

      - name: Create reports directory
        run: mkdir -p "$GITHUB_WORKSPACE/zap-reports"

      - name: Pull ZAP Docker image
        run: docker pull zaproxy/zap-stable:latest

      - name: Run ZAP Baseline Scan (docker)
        id: run-zap
        run: |
          set -e
          echo "Scanning $TARGET ..."
          # run container as the current runner user and set HOME to the mounted reports dir
          # avoid world-writable chmod and unnecessary sudo for security
          docker run --rm -u "$(id -u):$(id -g)" -e HOME=/zap/wrk -v "$GITHUB_WORKSPACE/zap-reports":/zap/wrk:rw -t zaproxy/zap-stable \
            zap-baseline.py -t "$TARGET" -r /zap/wrk/zap-report.html -J /zap/wrk/zap-report.json || true
        env:
          TARGET: ${{ env.TARGET }}

      - name: List reports
        run: ls -la "$GITHUB_WORKSPACE/zap-reports"

      - name: Upload HTML Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-html-report
          path: zap-reports/zap-report.html
          retention-days: 30

      - name: Upload JSON Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-json-report
          path: zap-reports/zap-report.json
          retention-days: 30

      - name: Upload ZAP YAML
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-yaml
          path: zap-reports/zap.yaml
          retention-days: 30

      - name: Add scan summary to workflow run
        if: always()
        run: |
          echo "## ZAP Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Target:** $TARGET" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Artifacts:" >> $GITHUB_STEP_SUMMARY
          echo "- zap-html-report (artifact)" >> $GITHUB_STEP_SUMMARY
          echo "- zap-json-report (artifact)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f "$GITHUB_WORKSPACE/zap-reports/zap-report.json" ]; then
            echo "### Quick findings from JSON (first-level)" >> $GITHUB_STEP_SUMMARY
            jq '.site[].alerts | length as $n | {site: .site, alerts_count: $n}' "$GITHUB_WORKSPACE/zap-reports/zap-report.json" 2>/dev/null || true
          fi
